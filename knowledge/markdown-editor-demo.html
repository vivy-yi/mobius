<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown编辑器演示 - Mobius知识库系统</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+SC:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="../style.css">
    <style>
        .demo-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .demo-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .editor-section {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .section-header {
            background: var(--gradient-blue);
            color: white;
            padding: 1rem 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .editor-content {
            padding: 2rem;
        }

        .markdown-editor {
            width: 100%;
            min-height: 300px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
            border: 2px solid var(--light-bg);
            border-radius: var(--radius-md);
            padding: 1rem;
            resize: vertical;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .markdown-editor:focus {
            border-color: var(--tech-blue);
        }

        .preview-section {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .preview-content {
            min-height: 300px;
            padding: 2rem;
            line-height: 1.8;
            color: var(--dark-text);
        }

        .preview-content h1 { font-size: 2rem; color: var(--primary-blue); margin: 1.5rem 0 1rem 0; }
        .preview-content h2 { font-size: 1.6rem; color: var(--primary-blue); margin: 1.5rem 0 1rem 0; }
        .preview-content h3 { font-size: 1.4rem; color: var(--primary-blue); margin: 1.5rem 0 1rem 0; }
        .preview-content p { margin-bottom: 1rem; }
        .preview-content strong { color: var(--primary-blue); font-weight: 600; }
        .preview-content em { font-style: italic; }
        .preview-content code { background: #f3f4f6; color: #d946ef; padding: 0.2rem 0.4rem; border-radius: 4px; font-family: monospace; }
        .preview-content blockquote { background: var(--light-bg); border-left: 4px solid var(--tech-blue); padding: 1rem 1.5rem; margin: 1rem 0; border-radius: 0 var(--radius-md) var(--radius-md) 0; }
        .preview-content ul, .preview-content ol { margin: 1rem 0; padding-left: 2rem; }
        .preview-content li { margin-bottom: 0.5rem; }

        .table-of-contents {
            background: var(--light-bg);
            padding: 1.5rem;
            border-radius: var(--radius-md);
            margin-bottom: 2rem;
            border-left: 4px solid var(--tech-blue);
        }

        .table-of-contents h3 {
            margin: 0 0 1rem 0;
            color: var(--primary-blue);
            font-size: 1.2rem;
        }

        .table-of-contents ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .table-of-contents li {
            margin-bottom: 0.5rem;
        }

        .table-of-contents a {
            color: var(--dark-text);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .table-of-contents a:hover {
            color: var(--tech-blue);
        }

        .seo-info {
            background: #f0f9ff;
            border: 2px solid #3b82f6;
            padding: 1.5rem;
            border-radius: var(--radius-md);
        }

        .seo-info h3 {
            color: var(--primary-blue);
            margin: 0 0 1rem 0;
        }

        .toolbar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .toolbar button {
            background: var(--tech-blue);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s ease;
        }

        .toolbar button:hover {
            background: var(--primary-blue);
        }

        @media (max-width: 768px) {
            .toolbar { justify-content: center; }
        }
    </style>
</head>
<body>
    <!-- 导航栏将通过components.js动态生成 -->

    <div class="demo-container">
        <header class="demo-header">
            <h1>Markdown编辑器演示</h1>
            <p>体验Mobius知识库系统的安全Markdown编辑和渲染功能</p>
        </header>

        <div class="editor-section">
            <div class="section-header">
                <i class="fas fa-edit"></i>
                Markdown编辑器
            </div>
            <div class="editor-content">
                <div class="toolbar">
                    <button onclick="insertMarkdown('**', '**')"><i class="fas fa-bold"></i> 粗体</button>
                    <button onclick="insertMarkdown('*', '*')"><i class="fas fa-italic"></i> 斜体</button>
                    <button onclick="insertMarkdown('`', '`')"><i class="fas fa-code"></i> 代码</button>
                    <button onclick="insertMarkdown('## ', '')"><i class="fas fa-heading"></i> 标题</button>
                    <button onclick="insertMarkdown('- ', '')"><i class="fas fa-list"></i> 列表</button>
                    <button onclick="insertMarkdown('> ', '')"><i class="fas fa-quote-left"></i> 引用</button>
                </div>
                <textarea id="markdownInput" class="markdown-editor" placeholder="在这里输入Markdown内容..."># 欢迎使用Markdown编辑器

这是一个**实时预览**的Markdown编辑器演示，采用安全的DOM操作方式。

## 主要功能

- **安全渲染**: 避免XSS攻击的安全转换
- **实时预览**: 输入内容立即显示效果
- **SEO优化**: 自动提取标题和描述

## 使用示例

### 文本格式
- **粗体文本**: 使用 `**文本**`
- *斜体文本*: 使用 `*文本*`
- `行内代码`: 使用 \`代码\`

### 列表和引用
1. 有序列表项
2. 另一个列表项

> 这是一个引用块，用于强调重要内容。

{{warning}}
重要提醒：这个系统使用安全的DOM操作，避免innerHTML带来的XSS风险。
{{/warning}}</textarea>
            </div>
        </div>

        <div class="preview-section">
            <div class="section-header">
                <i class="fas fa-eye"></i>
                实时预览
            </div>
            <div class="preview-content" id="previewContent">
                <p style="color: #64748b; text-align: center; padding: 2rem;">
                    在上方编辑器中输入Markdown内容，这里将实时显示渲染效果...
                </p>
            </div>
        </div>

        <div class="seo-info">
            <h3><i class="fas fa-search"></i> SEO信息</h3>
            <div id="seoInfo">
                <p>等待内容解析...</p>
            </div>
        </div>
    </div>

    <!-- Footer将通过components.js动态生成 -->

    <script src="../components/components.js?v=2.1"></script>
    <script src="../components/markdown-renderer.js?v=1.0"></script>
    <script>
        let renderTimer = null;

        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('markdownInput');

            // 初始渲染
            updatePreview(input.value);

            // 实时预览（防抖处理）
            input.addEventListener('input', function() {
                clearTimeout(renderTimer);
                renderTimer = setTimeout(() => {
                    updatePreview(this.value);
                }, 300);
            });
        });

        function updatePreview(markdown) {
            const previewContainer = document.getElementById('previewContent');
            const seoContainer = document.getElementById('seoInfo');

            if (!markdown.trim()) {
                // 使用安全的textContent显示提示信息
                previewContainer.innerHTML = '';
                const message = document.createElement('p');
                message.style.cssText = 'color: #64748b; text-align: center; padding: 2rem;';
                message.textContent = '在上方编辑器中输入Markdown内容，这里将实时显示渲染效果...';
                previewContainer.appendChild(message);

                seoContainer.innerHTML = '<p>等待内容解析...</p>';
                return;
            }

            try {
                const startTime = performance.now();

                // 使用安全渲染器
                const result = window.markdownRenderer.renderPage(markdown);
                const endTime = performance.now();
                const renderTime = (endTime - startTime).toFixed(2);

                // 安全地更新预览内容
                previewContainer.innerHTML = ''; // 清空现有内容

                // 使用安全的DOM附加方式
                if (result.dom) {
                    previewContainer.appendChild(result.dom.cloneNode(true));
                } else {
                    // 内容已经过安全处理，可以使用innerHTML
                    previewContainer.innerHTML = result.html;
                }

                // 更新SEO信息
                updateSEOInfo(result.seo, renderTime);

            } catch (error) {
                console.error('Markdown渲染错误:', error);

                // 安全地显示错误信息
                previewContainer.innerHTML = '';
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'color: #dc2626; padding: 1rem; background: #fef2f2; border-radius: 8px;';
                errorDiv.textContent = '内容解析失败: ' + error.message;
                previewContainer.appendChild(errorDiv);

                seoContainer.innerHTML = '<p style="color: #dc2626;">解析失败</p>';
            }
        }

        function updateSEOInfo(seoInfo, renderTime = '0.00') {
            const seoContainer = document.getElementById('seoInfo');

            // 创建安全的SEO信息显示
            seoContainer.innerHTML = '';

            const dl = document.createElement('dl');
            dl.style.cssText = 'display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem;';

            // 标题
            const titleDt = document.createElement('dt');
            titleDt.style.cssText = 'font-weight: 600; color: var(--dark-text);';
            titleDt.textContent = '页面标题:';

            const titleDd = document.createElement('dd');
            titleDd.style.cssText = 'margin: 0; color: var(--light-text);';
            titleDd.textContent = seoInfo.title || '未检测到标题';

            // 描述
            const descDt = document.createElement('dt');
            descDt.style.cssText = 'font-weight: 600; color: var(--dark-text);';
            descDt.textContent = '页面描述:';

            const descDd = document.createElement('dd');
            descDd.style.cssText = 'margin: 0; color: var(--light-text);';
            descDd.textContent = seoInfo.description || '未检测到描述';

            // 标题数量
            const headingsDt = document.createElement('dt');
            headingsDt.style.cssText = 'font-weight: 600; color: var(--dark-text);';
            headingsDt.textContent = '标题数量:';

            const headingsDd = document.createElement('dd');
            headingsDd.style.cssText = 'margin: 0; color: var(--light-text);';
            headingsDd.textContent = seoInfo.headings ? seoInfo.headings.length : 0;

            // 渲染耗时
            const timeDt = document.createElement('dt');
            timeDt.style.cssText = 'font-weight: 600; color: var(--dark-text);';
            timeDt.textContent = '渲染耗时:';

            const timeDd = document.createElement('dd');
            timeDd.style.cssText = 'margin: 0; color: var(--light-text);';
            timeDd.textContent = `${renderTime}ms`;

            // 组装SEO信息
            dl.appendChild(titleDt);
            dl.appendChild(titleDd);
            dl.appendChild(descDt);
            dl.appendChild(descDd);
            dl.appendChild(headingsDt);
            dl.appendChild(headingsDd);
            dl.appendChild(timeDt);
            dl.appendChild(timeDd);

            seoContainer.appendChild(dl);
        }

        function insertMarkdown(before, after) {
            const input = document.getElementById('markdownInput');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const selectedText = input.value.substring(start, end);
            const replacement = before + selectedText + after;

            input.value = input.value.substring(0, start) + replacement + input.value.substring(end);

            const newPosition = start + before.length + selectedText.length;
            input.setSelectionRange(newPosition, newPosition);
            input.focus();

            updatePreview(input.value);
        }
    </script>
</body>
</html>